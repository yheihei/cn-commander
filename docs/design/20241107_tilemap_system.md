# タイルマップシステム実装 設計書

作成日: 2024/11/07  
タスク: task-2-1 タイルマップシステム実装（512x512グリッド）

## 概要

Phaser3を使用した2Dタイルマップシステムの基盤を実装しました。このシステムは、16x16ピクセルのタイルを使用して最大512x512タイルのマップを管理・表示することができます。

## 実装内容

### 1. アセット管理
- タイルマップ画像を`assets/images/tilemaps/`に配置
- キャラクター画像を`assets/images/characters/`に配置
- 9種類の地形タイルセットをサポート（基本、道路、森林、砂漠、土、海、山3種）

### 2. タイプ定義

#### TileTypes.ts
- `TileType`列挙型: 平地、森林、山地の3種類の地形を定義
- `TerrainEffect`インターフェース: 地形効果（移動コスト、防御補正、攻撃補正、視界補正）
- `TERRAIN_EFFECTS`: 各地形タイプの効果値定義

#### MapTypes.ts
- `MapConfig`: マップ設定（タイルサイズ、マップサイズ等）
- `MapLayer`: マップレイヤー情報
- `MapData`: マップ全体のデータ構造
- `BaseData`: 拠点情報の構造

### 3. マップクラス

#### MapTile.ts
- 個別タイルを管理するクラス
- グリッド座標とピクセル座標の変換
- ホバー時のハイライト表示
- 地形効果の取得

#### MapLayer.ts
- タイルレイヤーを管理するクラス
- タイルの作成と配置
- レイヤーの表示/非表示制御
- 座標からタイルを取得

#### MapManager.ts
- マップ全体を統括管理するクラス
- マップデータの読み込み
- 複数レイヤーの管理
- 座標変換ユーティリティ
- デバッググリッド表示

### 4. シーン実装

#### PreloadScene.ts
- アセットの読み込み処理
- プログレスバー表示
- タイルマップとキャラクターのスプライトシート読み込み

#### GameScene.ts
- メインゲームシーン
- マップの表示と操作
- カメラ制御（ドラッグ移動、ズーム）
- デバッグ情報表示

### 5. テストマップ
- 40x40タイルのテストマップ（testMap.json）
- 平地、森林、山地を配置
- プレイヤーと敵の本拠地、中立拠点を配置

## 操作方法

### カメラ操作
- **矢印キー**: カメラを上下左右に移動
- **右クリックドラッグ**: カメラをドラッグ移動
- **マウスホイール**: ズームイン/アウト
- **Qキー**: ズームアウト
- **Eキー**: ズームイン
- **Dキー**: デバッグ情報の表示/非表示

### タイル情報
- マウスホバーでタイルがハイライト
- デバッグモード時は地形効果などの詳細情報を表示

## 技術的特徴

1. **モジュラー設計**: タイル、レイヤー、マネージャーを分離して管理
2. **型安全**: TypeScriptの型定義により型安全性を確保
3. **パフォーマンス**: 大規模マップ（512x512）に対応可能な設計
4. **拡張性**: 新しい地形タイプやレイヤーの追加が容易

## 今後の拡張ポイント

1. **地形効果の実装**: 移動コストや戦闘補正の実際の適用
2. **フォグオブウォー**: 未探索エリアの表示制御
3. **マップエディター**: マップ作成ツールの実装
4. **最適化**: 大規模マップでのカリング処理

## ファイル構成

```
src/
├── types/
│   ├── TileTypes.ts      # タイルタイプ定義
│   └── MapTypes.ts       # マップ関連型定義
├── config/
│   └── mapConfig.ts      # マップ設定
├── map/
│   ├── MapTile.ts        # タイルクラス
│   ├── MapLayer.ts       # レイヤークラス
│   └── MapManager.ts     # マップ管理クラス
├── scenes/
│   ├── PreloadScene.ts   # アセット読み込みシーン
│   └── GameScene.ts      # ゲームシーン
└── index.ts              # エントリーポイント

assets/
├── images/
│   ├── tilemaps/         # タイルマップ画像
│   └── characters/       # キャラクター画像
└── data/
    └── maps/             # マップデータJSON
```

## 動作確認

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build
```

ブラウザで`http://localhost:8080`にアクセスして動作を確認できます。