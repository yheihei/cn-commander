# [task-2-1] タイルマップシステム実装

## 概要
- エピック: #2
- タスク: #2-1
- 関連PR/要件: 512x512グリッドのタイルマップシステム実装

## 設計方針

### 技術選定
- **Phaser 3**: ゲームエンジンとして採用
- **TypeScript**: 型安全性を確保
- **モジュラー設計**: タイル、レイヤー、マネージャーを分離して管理

### アーキテクチャ選択理由
- **コンポーネント分離**: MapTile、MapLayer、MapManagerの3層構造により、責務を明確に分離
- **大規模対応**: 512x512タイル（262,144タイル）の処理を想定した設計
- **拡張性**: 新しい地形タイプやレイヤーの追加が容易

## アーキテクチャ詳細

### クラス構成

#### MapManager（マップ統括管理）
- **責務**: マップ全体の管理、レイヤーの統合、座標変換サービスの提供
- **主要機能**:
  - マップデータの読み込みと初期化
  - レイヤー管理（複数レイヤーのサポート）
  - 座標変換（グリッド⇔ピクセル）
  - 拠点情報の管理

#### MapLayer（レイヤー管理）
- **責務**: 個別レイヤーのタイル管理と描画制御
- **主要機能**:
  - タイルの生成と配置
  - レイヤー単位での表示/非表示制御
  - タイルへのアクセス提供

#### MapTile（個別タイル）
- **責務**: 個々のタイルの状態管理と地形情報の保持
- **主要機能**:
  - タイルタイプと地形効果の管理
  - 座標情報の保持（グリッド座標、ピクセル座標）
  - スプライト表示の制御

### データ構造

#### MapData（マップ定義）
- **name**: マップ名称
- **width/height**: マップサイズ（タイル数）
- **tileSize**: タイルサイズ（16px固定）
- **layers**: レイヤー情報の配列
- **startPositions**: プレイヤー/敵の初期位置
- **bases**: 拠点配置情報

#### 座標システム
- **グリッド座標**: タイル単位の論理座標（0-511の範囲）
- **ピクセル座標**: 画面上の実際の描画位置
- **座標変換**: タイルサイズ（16px）を基準とした相互変換

### アルゴリズムの説明

#### タイル配置方式
- タイルタイプの2次元配列からマップを構築
- 各タイルはグリッド座標に基づいて配置
- レイヤーごとにコンテナで管理し、描画順序を制御

#### 座標変換ロジック
- グリッド座標からピクセル座標への変換（タイル中心座標を計算）
- ピクセル座標からグリッド座標への逆変換（タイル判定用）
- マップ境界チェックによる不正座標の除外

## インターフェース定義

### 公開API
- `loadMap(mapData: MapData)`: マップデータを読み込み
- `getTileAt(x, y, layerName?)`: 指定座標のタイルを取得
- `getBaseAt(x, y)`: 指定座標の拠点を取得
- `pixelToGrid(pixelX, pixelY)`: ピクセル座標をグリッド座標に変換
- `gridToPixel(gridX, gridY)`: グリッド座標をピクセル座標に変換

### イベント/コールバック
- タイルホバー時: ハイライト表示
- タイルクリック時: 将来的にユニット移動等で使用予定

### 他システムとの連携
- **GameScene**: MapManagerを通じてマップを操作
- **UnitSystem（未実装）**: タイルの地形効果を参照
- **CameraSystem**: マップサイズに基づいてカメラ境界を設定

## テスト方針

### 統合テストの観点
1. **基本機能の統合確認**
   - 512x512サイズのマップ生成
   - タイルの正しい配置
   - レイヤーの管理

2. **境界値と異常系**
   - マップ境界外へのアクセス
   - 不正なタイルタイプの処理
   - サイズ不整合のマップデータ

3. **パフォーマンス確認**
   - 大規模マップ（100x100でテスト）の生成時間
   - タイルアクセスの速度

4. **実使用シナリオ**
   - 2点間の情報取得
   - 範囲内タイルの取得
   - 拠点周辺の情報確認

## 未解決事項
- [ ] メモリ最適化: 512x512フルサイズでのメモリ使用量削減
- [ ] カリング処理: 画面外タイルの描画スキップ
- [ ] タイルセットの動的読み込み: 現在はハードコードされている
- [ ] パフォーマンス最適化: Phaser.Tilemapの使用検討
