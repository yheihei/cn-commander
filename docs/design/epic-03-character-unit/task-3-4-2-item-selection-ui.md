# [task-3-4-2] アイテム選択UI

## 概要
- エピック: #3
- タスク: #3-4-2
- 関連PR/要件: @docs/prd/requirements.md セクション2.1.5（軍団編成）、セクション2.3（アイテムシステム）
- 親タスク: #3-4（軍団編成UI）
- 前タスク: #3-4-1（兵士選択UI）

## 設計方針

### 全体アプローチ
- 兵士選択完了後のアイテム割り当て画面
- 倉庫のアイテムを各兵士に配布（最大4個/人）
- 最初の武器は自動装備、その後は手動で装備変更可能
- 全画面モーダルUIの継続使用

### 技術選定理由
- Phaser3のContainerシステム：既存UIとの統一性
- クリック操作：シンプルで直感的なアイテム配布
- 武器の自動装備：最初の武器が自動的に装備されることで操作を簡略化

## インターフェース定義

### ItemSelectionUIクラス
```typescript
class ItemSelectionUI extends Phaser.GameObjects.Container {
  constructor(config: ItemSelectionUIConfig);
  
  // 表示/非表示
  show(): void;
  hide(): void;
  
  // アイテムと兵士データの設定
  setFormationData(data: FormationData): void;
  updateInventory(items: IItem[]): void;
  
  // アイテム割り当て
  assignItem(soldierIndex: number, item: IItem): void;
  removeItem(soldierIndex: number, itemIndex: number): void;
  
  // 装備変更
  equipWeapon(soldierIndex: number, itemIndex: number): void;
}

interface ItemSelectionUIConfig {
  scene: Phaser.Scene;
  base: Base;
  formationData: FormationData;  // task-3-4-1から受け取る
  onProceedToDeployment?: (data: ItemEquippedFormationData) => void;
  onBack?: () => void;  // 兵士選択画面に戻る
  onCancelled?: () => void;
}
```

### ItemEquippedFormationData型
```typescript
interface ItemEquippedFormationData {
  commander: Character;
  soldiers: Character[];
  items: Map<Character, IItem[]>;  // 各キャラクターの所持アイテム
}
```

## データ構造の概要

### 倉庫アイテムの管理
- BaseManagerから倉庫アイテムリストを取得
- アイテムの種類：武器（忍者刀、手裏剣、弓）、消耗品（兵糧丸）
- 在庫数の管理と表示
- ページネーション機能：1ページに3アイテムまで表示

### アイテム割り当ての制約
- 各兵士最大4アイテムまで
- 最初に追加された武器（刀剣/飛び道具）が自動的に装備される
- 装備は手動で変更可能（[装備]ボタンをクリック）
- 同じアイテムの複数所持可能

## 実装の詳細

### レイアウト仕様
- 全画面モーダルUI（兵士選択画面と同じ）
- 左側：現在選択中の兵士の詳細（1名のみ表示）
- 右側：倉庫アイテム一覧
- 下部：操作ボタン

#### 詳細レイアウト
```
+--------------------------------------------------------------------------------+
|                        軍団編成 - アイテム選択                                  |
+--------------------------------------------------------------------------------+
| [◀] 風太郎（風忍） [▶]            | [◀] 倉庫アイテム（1/2） [▶]              |
|----------------------------------|-------------------------------------------|
| 所持アイテム:                     | 忍者刀 x12                                |
| 1.忍者刀（耐久100/100）装備中[✗] | 攻撃力+15、射程1-3                         |
|   （赤色で表示）                  |                                           |
| 2.兵糧丸                    [✗] | 手裏剣 x25                                |
| 3.手裏剣（耐久80/100）[装備][✗] | 攻撃力+5、射程1-6                          |
| 4.[空きスロット]                 |                                           |
|                                  | 弓 x10                                    |
|                                  | 攻撃力+2、射程4-12                         |
|                                  |                                           |
|                                  |                                           |
+--------------------------------------------------------------------------------+
|  [戻る]                                        [出撃位置選択]                    |
+--------------------------------------------------------------------------------+
```

### 兵士表示仕様
- 1画面に1名の兵士のみ表示（個別表示方式）
- 兵士の名前と職業名を表示（例：風太郎（風忍））
- ページネーション：[◀][▶]ボタンで兵士を切り替え
- 所持アイテムは常に展開表示
- 各アイテムには削除用の[✗]マークを右側に表示
- 装備中の武器は赤色で表示し「装備中」の文字を表示
- 装備可能な武器には[装備]ボタンを表示

### アイテム表示仕様
- アイテム名と在庫数
- アイテムの詳細情報（攻撃力、射程、効果など）
- 在庫0のアイテムはグレーアウト
- ページネーション：1ページに3アイテムまで表示
- ページ番号表示（例：1/2）
- [◀][▶]ボタンでページ切り替え（最初/最後でループ）

### インタラクション仕様
- **兵士切り替え**: [◀][▶]ボタンで前後の兵士に移動（最初/最後でループ）
- **アイテム追加**: 倉庫アイテムをクリックで現在表示中の兵士に追加
- **アイテム削除**: 所持アイテムの[✗]マークをクリックで倉庫に戻す
- **武器装備**: 武器の[装備]ボタンをクリックで装備変更（既存装備は自動的に解除）
- **自動装備**: 最初に追加された武器（刀剣/飛び道具）が自動的に装備される

## 画面遷移フロー

### 全体フロー
```
[兵士選択画面] ← task-3-4-1
  ↓
[アイテム選択画面] ← 本タスクの設計範囲
  ↓
[出撃位置選択] ← task-3-4-3
```

### アイテム選択画面の役割
1. 選択された兵士にアイテムを配布
2. 武器の自動装備機能を提供
3. 完了後、ItemEquippedFormationDataを生成して次画面へ

## 次タスクへの受け渡し事項
- **task-3-4-3へ**: ItemEquippedFormationData（兵士とアイテムの情報）
- **コールバック**: onProceedToDeployment(data: ItemEquippedFormationData)

## 未解決事項
- [ ] アイテムアイコンの表示方法（スプライトシート）
- [ ] 在庫管理の更新タイミング（即座に反映 or 出撃確定時）
- [ ] アイテムが1つもない場合の処理
- [ ] 兵士選択時の視覚的フィードバック（ハイライト色など）