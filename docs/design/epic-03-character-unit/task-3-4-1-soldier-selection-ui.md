# [task-3-4-1] 兵士選択UI

## 概要
- エピック: #3
- タスク: #3-4-1
- 関連PR/要件: @docs/prd/requirements.md セクション2.1.5
- 親タスク: #3-4（軍団編成UI）

## 設計方針

### 全体アプローチ
- 全画面幅のモーダル形式UIとして実装
- 「兵士選択」→「アイテム選択」→「出撃」の3段階フローを採用
- 既存のUIパターン（Phaser.GameObjects.Container継承）に従った実装
- クリック操作を中心としたシンプルなインタラクション
- 背景に半透明のオーバーレイを配置してモーダル感を演出

### 技術選定理由
- Phaser3のContainerシステム：既存UIとの統一性を保持
- テーブル形式レイアウト：兵士の詳細情報を一覧で確認可能
- 全画面モーダル：編成に集中できる没入型UI
- 左右クリック操作：直感的な兵士の選択/解除操作

## インターフェース定義

### ArmyFormationUIクラス
```typescript
class ArmyFormationUI extends Phaser.GameObjects.Container {
  constructor(config: ArmyFormationUIConfig);
  
  // 表示/非表示
  show(): void;
  hide(): void;
  
  // 待機兵士の更新
  updateWaitingSoldiers(soldiers: Character[]): void;
  
  // スロット選択状態の管理
  selectSlot(type: 'commander' | 'soldier', index?: number): void;
  getSelectedSlot(): { type: string; index?: number } | null;
  
  // 兵士の割り当て/解除
  assignSoldier(soldier: Character): void;
  removeSoldier(slotType: 'commander' | 'soldier', index?: number): void;
}

interface ArmyFormationUIConfig {
  scene: Phaser.Scene;
  base: Base;
  onProceedToItemSelection?: (data: FormationData) => void;
  onCancelled?: () => void;
}
```

### FormationData型
```typescript
interface FormationData {
  commander: Character;  // 必須（最低1名は必要）
  soldiers: Character[]; // 0〜3名
  // アイテムは次の画面（アイテム選択画面）で選択
}
```

### 内部コンポーネント構成
- **メインエリア（兵士選択画面）**: 
  - 待機兵士のテーブル表示
  - テーブルヘッダー：名前、職業、HP、攻撃力、防御力、速さ、移動速度、視界
  - 各行：兵士の詳細情報とマーク表示エリア
  - 選択状態表示：指揮官マーク（赤い「指」）、兵士マーク（青い「兵」）
  - ページネーション（1ページに5人まで表示）
  
- **下部エリア（操作ボタン）**:
  - 「アイテム選択」ボタン：アイテム選択画面へ遷移（1名以上選択時に有効）
  - 「キャンセル」ボタン：編成を破棄して閉じる

### インタラクションフロー
```typescript
// 1. 兵士の選択（左クリック）
// 待機兵士テーブルの行を左クリック
// → 1人目：指揮官マーク（赤い「指」）を表示
// → 2人目以降：兵士マーク（青い「兵」）を表示（最大3名まで）
// → 既に4名選択済みの場合は警告メッセージ表示

// 2. 兵士の解除（右クリック）
// 選択済み兵士の行を右クリック
// → 該当兵士のマークを削除
// → 指揮官を解除した場合：全員のマークを削除し、選択し直し

// 3. アイテム選択ボタンの状態管理
// 0名選択時：ボタン無効化（グレー表示）
// 1名以上選択時：ボタン有効化

// 4. アイテム選択画面への遷移
// 「アイテム選択」ボタンをクリック（有効時のみ）
// → FormationDataを生成してコールバック実行
// → 兵士選択画面を非表示にし、アイテム選択画面を表示

// 5. キャンセル処理
// 「キャンセル」ボタンをクリック
// → 選択状態をすべてクリア
// → 軍団編成UIを閉じる
```

### UIManagerとの連携
```typescript
// UIManagerへの追加メソッド
interface UIManager {
  showArmyFormationUI(base: Base): void;
  hideArmyFormationUI(): void;
  isArmyFormationUIVisible(): boolean;
}
```

## データ構造の概要

### 拠点の待機兵士管理
- BaseManagerが各拠点の待機兵士リストを管理
- 軍団編成時に待機兵士から除外し、解散時に追加
- 駐留軍団とは別管理（駐留は軍団単位、待機は個人単位）

### 編成中の一時データ
- ArmyFormationUIが編成中のデータを保持
- 確定前はゲームステートに反映しない
- キャンセル時は全データを破棄

## 実装の詳細

### レイアウト仕様
- 全画面幅のモーダルUI（画面中央に配置）
- 背景：半透明の黒（alpha: 0.5）でオーバーレイ
- メインパネル：画面幅の90%、高さの85%
- テーブルエリア：パネル内の上部80%を使用
- 下部ボタンエリア：高さ60px

#### 詳細レイアウト
```
+-------------------------------------------------------------------------+
|                        軍団編成 - 兵士選択                              |
+-------------------------------------------------------------------------+
| 名前     | 職業   | HP    | 攻撃力 | 防御力 | 速さ | 移動速度 | 視界 | |
+----------+--------+-------+--------+--------+------+----------+------+-+
| 風太郎   | 風忍   | 30/30 | 20     | 10     | 20   | 13       | 8    |指|
| 鉄壁花子 | 鉄忍   | 50/50 | 15     | 25     | 15   | 8        | 6    |兵|
| 影丸     | 影忍   | 35/35 | 30     | 12     | 25   | 12       | 11   |兵|
| 薬師梅   | 薬忍   | 40/40 | 12     | 15     | 18   | 10       | 9    | |
| 風小僧   | 風忍   | 28/28 | 18     | 9      | 22   | 14       | 8    | |
+----------+--------+-------+--------+--------+------+----------+------+-+
|      [ < ]                    1 / 3 ページ                   [ > ]      |
+-------------------------------------------------------------------------+
|                                                                         |
|    [キャンセル]                                   [アイテム選択]        |
+-------------------------------------------------------------------------+
```

### テーブル表示仕様
- **ヘッダー行**: 背景色#333333、文字色#ffffff
- **データ行**: 
  - 高さ：40px
  - 偶数行背景色：#2a2a2a
  - 奇数行背景色：#222222
  - ホバー時：背景色を#444444に変更
  - 選択済み行：背景色を#334455に変更
- **カラム幅**:
  - 名前：100px
  - 職業：60px
  - HP：60px
  - 攻撃力：60px
  - 防御力：60px
  - 速さ：50px
  - 移動速度：70px
  - 視界：50px
  - マーク：40px

### マーク表示仕様
- **指揮官マーク**: 
  - 表示：赤い「指」文字
  - フォントサイズ：16px
  - 色：#FF4444
- **兵士マーク**: 
  - 表示：青い「兵」文字
  - フォントサイズ：16px
  - 色：#4444FF
- **表示位置**: 各行の右端カラムに表示
- **右クリック可能エリア**: 行全体

### 職業名表示マッピング
- wind → 風忍
- iron → 鉄忍
- shadow → 影忍
- medicine → 薬忍

### アイテム選択ボタン仕様
- **有効化条件**: 1名以上の兵士が選択されている
- **無効時表示**: グレーアウト、クリック不可
- **有効時表示**: 通常色、クリック可能
- **軍団最小構成**: 指揮官1名のみ（一般兵は0名でも可能）

### ページネーション仕様
- **表示人数**: 1ページあたり5人まで表示
- **ページ切り替えボタン**:
  - 「<」ボタン：前のページへ移動
  - 「>」ボタン：次のページへ移動
  - 無効時はグレーアウト表示（最初/最後のページ時）
- **ページ情報表示**: 「現在ページ / 総ページ数 ページ」形式
- **選択状態の保持**: ページを移動しても選択状態は保持される
- **ボタン配置**: テーブルの下、操作ボタンの上に配置
- **初期表示**: 常に1ページ目から表示

## 画面遷移フロー

### 全体フロー
```
拠点選択 → 兵舎選択 → 軍団編成選択
  ↓
[兵士選択画面] ← 本タスクの設計範囲
  ↓
[アイテム選択画面] ← task-3-4-2
  ↓
[出撃位置選択] ← task-3-4-3
  ↓
軍団生成・出撃
```

### 兵士選択画面の役割
1. 待機兵士から軍団メンバーを選択（1〜4名）
2. 1人目は自動的に指揮官として設定
3. 選択完了後、FormationDataを生成してアイテム選択画面へ

### 選択処理の詳細
- **選択順序管理**: 内部で選択順序を記録（1番目=指揮官、2〜4番目=兵士）
- **最大選択数制限**: 4名まで（それ以上の選択は警告表示）
- **指揮官解除時の処理**: 
  1. 全選択をクリア
  2. 選択順序をリセット
  3. ユーザーに再選択を促すメッセージ表示

## 次タスクへの受け渡し事項
- **task-3-4-2へ**: FormationData（commander、soldiers配列）
- **コールバック**: onProceedToItemSelection(data: FormationData)

## 未解決事項
- [ ] 最大同時軍団数（6軍団）に達した場合のUI表示と制限
- [x] テーブルのスクロール実装詳細（ページネーション方式で実装済み）
- [ ] 右クリックイベントの実装方法（Phaser3でのコンテキストメニュー無効化）
- [ ] 待機兵士が0名の場合の表示