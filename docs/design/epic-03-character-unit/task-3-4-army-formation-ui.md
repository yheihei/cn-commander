# [task-3-4] 軍団編成UI

## 概要
- エピック: #3
- タスク: #3-4
- 関連PR/要件: @docs/prd/requirements.md セクション2.1.5

## 設計方針

### 全体アプローチ
- 全画面幅のモーダル形式UIとして実装
- 左右分割レイアウトで直感的な操作を実現（タブ式は不採用）
- 既存のUIパターン（Phaser.GameObjects.Container継承）に従った実装
- クリック操作を中心としたシンプルなインタラクション
- 背景に半透明のオーバーレイを配置してモーダル感を演出

### 技術選定理由
- Phaser3のContainerシステム：既存UIとの統一性を保持
- 左右分割レイアウト：編成エリアと待機兵士リストを同時表示
- 全画面モーダル：編成に集中できる没入型UI
- クリック&アサイン方式：直感的な兵士割り当て操作

## インターフェース定義

### ArmyFormationUIクラス
```typescript
class ArmyFormationUI extends Phaser.GameObjects.Container {
  constructor(config: ArmyFormationUIConfig);
  
  // 表示/非表示
  show(): void;
  hide(): void;
  
  // 待機兵士の更新
  updateWaitingSoldiers(soldiers: Character[]): void;
  
  // スロット選択状態の管理
  selectSlot(type: 'commander' | 'soldier', index?: number): void;
  getSelectedSlot(): { type: string; index?: number } | null;
  
  // 兵士の割り当て/解除
  assignSoldier(soldier: Character): void;
  removeSoldier(slotType: 'commander' | 'soldier', index?: number): void;
}

interface ArmyFormationUIConfig {
  scene: Phaser.Scene;
  base: Base;
  onProceedToItemSelection?: (data: FormationData) => void;
  onCancelled?: () => void;
}
```

### FormationData型
```typescript
interface FormationData {
  commander: Character | null;
  soldiers: (Character | null)[];
  // アイテムは次の画面（アイテム選択画面）で選択
}
```

### 内部コンポーネント構成
- **左側エリア（編成エリア）**: 
  - 指揮官スロット（1つ）：クリックで選択状態に
  - 一般兵スロット（3つ）：クリックで選択状態に
  - 各スロットに割り当てられた兵士の表示
  - 割り当て済み兵士にはバツマーク表示
  
- **右側エリア（待機兵士リスト）**: 
  - 拠点の待機兵士一覧を表示
  - スクロール可能なリスト形式
  - クリックで選択中のスロットに兵士を割り当て
  
- **下部エリア（操作ボタン）**:
  - 「出撃準備」ボタン：アイテム選択画面へ遷移
  - 「キャンセル」ボタン：編成を破棄して閉じる

### インタラクションフロー
```typescript
// 1. スロット選択
// ユーザーが編成エリアのスロットをクリック
// → 選択状態を視覚的に表示（ハイライト等）

// 2. 兵士割り当て
// 待機兵士リストから兵士をクリック
// → 選択中のスロットに兵士を割り当て
// → 割り当て済み兵士にバツマークを表示

// 3. 割り当て解除
// バツマークをクリック
// → 該当スロットから兵士を解除
// → 待機兵士リストに復帰

// 4. 出撃準備ボタンの状態管理
// 指揮官未選択時：ボタン無効化（グレー表示）
// 指揮官選択済み：ボタン有効化（一般兵は0人でも可）

// 5. 出撃準備
// 「出撃準備」ボタンをクリック（有効時のみ）
// → FormationDataを生成してコールバック実行
// → アイテム選択画面へ遷移
```

### UIManagerとの連携
```typescript
// UIManagerへの追加メソッド
interface UIManager {
  showArmyFormationUI(base: Base): void;
  hideArmyFormationUI(): void;
  isArmyFormationUIVisible(): boolean;
}
```

## データ構造の概要

### 拠点の待機兵士管理
- BaseManagerが各拠点の待機兵士リストを管理
- 軍団編成時に待機兵士から除外し、解散時に追加
- 駐留軍団とは別管理（駐留は軍団単位、待機は個人単位）

### 編成中の一時データ
- ArmyFormationUIが編成中のデータを保持
- 確定前はゲームステートに反映しない
- キャンセル時は全データを破棄

## 実装の詳細

### レイアウト仕様
- 全画面幅のモーダルUI（画面中央に配置）
- 背景：半透明の黒（alpha: 0.5）でオーバーレイ
- メインパネル：画面幅の90%、高さの85%
- 左右分割比率：左側40%（編成エリア）、右側60%（待機兵士リスト）
- 下部ボタンエリア：高さ60px

#### 詳細レイアウト
```
+------------------------------------------+
|           軍団編成                       |
+------------------+----------------------+
|                  |                      |
|  編成エリア      |  待機兵士リスト      |
|                  |                      |
| [指揮官]         |  [兵士1] [兵士2]     |
|                  |  [兵士3] [兵士4]     |
| [一般兵1]        |  [兵士5] [兵士6]     |
| [一般兵2]        |  ...（スクロール）   |
| [一般兵3]        |                      |
|                  |                      |
+------------------+----------------------+
|    [キャンセル]          [出撃準備]      |
+------------------------------------------+
```

### スロット表示仕様
- スロットサイズ：120x150px
- 空きスロット：点線枠で表示
- 選択中スロット：黄色のハイライト
- 割り当て済み：兵士の顔画像＋名前＋バツマーク（右上）

### 待機兵士リスト仕様  
- グリッド形式：2列×N行
- 兵士カード：140x180px
- 内容：顔画像、名前、職業、基本ステータス
- スクロール：縦スクロール可能（兵士数が多い場合）

### バツマーク仕様
- サイズ：20x20px
- 位置：兵士アイコンの右上
- 色：赤（#FF0000）
- ホバー時：明るくなる
- クリック範囲：バツマーク周辺も含む

### 出撃準備ボタン仕様
- **有効化条件**: 指揮官が1人以上選択されている
- **無効時表示**: グレーアウト、クリック不可
- **有効時表示**: 通常色、クリック可能
- **軍団最小構成**: 指揮官1名のみ（一般兵は0名でも出撃可能）

## 未解決事項
- [ ] アイテム選択画面の詳細設計（「出撃準備」ボタン押下後の画面）
- [ ] アイテム選択画面への遷移処理とデータ受け渡し
- [ ] 出撃位置選択UIの詳細（アイテム選択後の処理）
- [ ] 最大同時軍団数（6軍団）に達した場合のUI表示
- [ ] 待機兵士リストのスクロール実装詳細（Phaser3でのスクロール実装方法）