# クリプト忍者咲耶コマンダー 要求定義書

## 1. ゲーム概要

### 1.1 基本情報
- **ゲームタイトル**: クリプト忍者咲耶コマンダー
- **ジャンル**: 2Dドット絵リアルタイムストラテジー（RTS）
- **プラットフォーム**: PCブラウザー
- **開発フレームワーク**: Phaser 3
- **画面解像度**: 1280x720（16:9）
- **フレームレート**: 30FPS目標
- **視点**: トップダウンビュー
- **アートスタイル**: 16bit風ドット絵（タイルサイズ: 16x16px）

### 1.2 世界観・ストーリー
- **舞台**: 現代の日本をモチーフにした架空の世界。忍者は普通の人にまじりつつ、コンビニのバイトなどをしながら、ひっそりと生活している
- **主人公**: クリプトニンジャ・咲耶（さくや）- 甲賀の女忍者
- **敵**: 風魔一族

## 2. コアゲームシステム

### 2.1 戦闘システム

#### 2.1.1 リアルタイム戦闘
- リアルタイムで進行（一時停止機能あり）
- 軍団単位での操作
- 単体軍団選択のみ

#### 2.1.2 軍団編成（バトルコマンダー準拠）
- **軍団の定義**: 操作の基本単位
- 1軍団 = 1指揮官+3人の一般忍者（合計4人）
- 最大同時出撃軍団数: 6軍団
- **軍団構成**:
  - 指揮官：1名（必須）- いずれかのクラスの忍者
  - 一般兵：3名 - 任意のクラスの忍者
- **軍団と個人の関係**:
  - 移動：軍団単位で行動（4人が一緒に移動）
  - HP：各メンバーが個別にHPを持つ
  - 戦闘：各メンバーが個別に攻撃を行う
  - 撃破：HPが0になったメンバーは消滅し、そのステージでは再出撃不可
  - 軍団消滅条件：軍団の構成員が0名になった時点
- **軍団能力値の決定**:
  - 移動速度：構成メンバーの移動速度の平均値
  - 視界：各メンバーが各々視界を持ち、敵を発見できる

#### 2.1.3 移動・戦闘モード

| モード | 移動速度 | 攻撃可否 | 視界補正 |
|--------|----------|----------|----------|
| 通常移動 | 100% | 不可 | ±0マス |
| 戦闘移動 | 60% | 可能 | ±0マス |
| 待機 | 0% | 可能 | +1マス |

#### 2.1.4 移動指示システム（バトルコマンダー準拠）

##### 移動指示の操作フロー
1. **軍団選択**: 移動させたい軍団を左クリック
2. **移動モード選択**: 通常移動または戦闘移動を選択
3. **経路指定**: 最大4地点を順番にクリックして経路を設定
   - 各地点は直線で結ばれる
   - 地形を考慮した最短経路ではなく、指定通りの経路を移動
4. **移動開始**: 軍団が指定経路に沿って移動

##### 移動速度計算
```
軍団移動速度 = (指揮官の移動速度 + 一般忍者3名の移動速度合計) ÷ 軍団人数

実際の移動時間（秒/マス） = (40 / 軍団移動速度) × (1 / モード補正) × 地形コスト

例1：風忍指揮官（移動速度13）+ 混成部隊（移動速度10、12、13）の軍団
軍団移動速度 = (13 + 10 + 12 + 13) ÷ 4 = 12
通常移動で平地を通過 = (40 / 12) × (1 / 1.0) × 1.0 = 3.33秒/マス

例2：鉄忍指揮官（移動速度8）+ 混成部隊（移動速度10、11、12）の軍団
軍団移動速度 = (8 + 10 + 11 + 12) ÷ 4 = 10.25
戦闘移動で森林を通過 = (40 / 10.25) × (1 / 0.6) × 1.5 = 9.76秒/マス
```

#### 2.1.5 軍団編成システム（バトルコマンダー準拠）

##### 軍団編成フロー
1. **拠点選択**: 兵士がいる拠点をクリックで選択
2. **出撃コマンド**: コマンドメニューから「出撃」を選択
3. **軍団編成画面への遷移**: 
   - 画面が軍団編成モードに切り替わる
   - 拠点に待機中の兵士一覧が表示される
4. **指揮官選択**: 
   - 待機中の任意の忍者から1名を選択（必須）
   - 指揮官がいない場合は編成不可
5. **一般兵選択**: 
   - 残りの待機中忍者から最大3名まで選択
   - 最小1名、最大3名の選択が可能
6. **出撃位置選択**:
   - 拠点の周囲2マス以内から出撃位置を選択
   - 他の軍団や障害物がある場所は選択不可
7. **軍団出撃**: 
   - 「出撃」ボタンで軍団が指定位置に配置される
   - 編成した兵士は拠点の待機リストから除外される

##### 編成制限
- 同一の兵士を複数の軍団に所属させることは不可
- 指揮官は必ず1名必要（指揮官なしでは編成不可）
- 拠点に兵士がいない場合は出撃不可

#### 2.1.6 地形効果（簡略版）

| 地形タイプ | 移動コスト | 防御補正 | 攻撃補正 | 視界補正 |
|-----------|------------|----------|----------|----------|
| 平地 | 1.0 | +0% | +0% | ±0マス |
| 森林 | 1.5 | +20% | -10% | -2マス |
| 山地 | 2.0 | +30% | +15% | +3マス |

#### 2.1.7 戦闘計算式（バトルコマンダー準拠） https://battle-commander.nkden.com/know-hows/

##### 基本戦闘メカニクス
- **攻撃単位**: 軍団内の生存メンバー全員が個別に攻撃
- **攻撃タイミング**: 各メンバーの速さに応じた間隔で自動攻撃
- **目標選択**: 敵軍団内の生存メンバーからランダムに選択
- **ダメージ**: 攻撃成功時、対象メンバーのHPを1減少

##### 戦闘計算式
```
ダメージ量 = 1（固定値）
攻撃成功率 = (攻撃側の攻撃力 + 武器補正) / (攻撃側の攻撃力 + 武器補正 + 防御側の防御力) × 100%
攻撃間隔 = 90 / 速さ（秒）

各メンバーの攻撃力・防御力・速さ：
- 各メンバーが自身のステータスを使用

例1：攻撃力30のメンバーが攻撃する場合
- 防御力10の敵: 成功率75%
- 防御力30の敵: 成功率50%  
- 防御力70の敵: 成功率30%

例2：攻撃間隔の計算
- 速さ20の忍者: 4.5秒に1回攻撃
- 速さ16の忍者: 5.625秒に1回攻撃
- 速さ15の忍者: 6秒に1回攻撃
```

#### 2.1.8 攻撃範囲・射程

| 武器タイプ | 最小射程 | 最大射程 | 攻撃範囲 |
|-----------|----------|----------|----------|
| 刀 | 1 | 3 | 単体 |
| 手裏剣 | 2 | 6 | 単体 |

#### 2.1.9 視界システムと発見メカニクス

##### 視界の基本ルール
- **視界範囲**: 各メンバーが個別の視界を持つ（職業とモードにより決定）
- **視界共有**: 同一軍団内のメンバー間で視界を共有
- **発見状態**: 
  - 未発見: 敵軍団の位置・状態が不明（マップ上に表示されない）
  - 発見済み: 敵軍団の位置・状態が判明（マップ上に表示される）

##### 発見メカニクス
1. **初期状態**:
   - 全ての敵軍団は「未発見」状態でスタート
   - 敵軍団は見えない状態で移動し、本拠地制圧を目指す

2. **発見条件**:
   - 味方ユニットの視界範囲に敵ユニットが入る
   - 発見は軍団内の任意のメンバーの視界で成立
   - 一度発見された敵軍団は、視界外に出ても表示継続

3. **戦闘との関係**:
   - 未発見の敵は攻撃対象にできない
   - 発見済みの敵のみが攻撃対象となる
   - 敵軍も同じロジックで味方を発見・攻撃

4. **戦術的意味**:
   - 未発見状態を維持すれば、敵陣深くへの潜入が可能
   - 視界の広い影忍を偵察に使う戦術が有効
   - 森林地形（視界-2マス）を利用したステルス移動

##### 視界計算
```
実効視界 = 基本視界 + クラスボーナス + モード補正 + 地形補正

例：影忍（基本視界8）が山地（+3マス）で待機（+1マス）
実効視界 = 8 + 0 + 1 + 3 = 12マス
```

#### 2.1.10 攻撃システム詳細

##### 攻撃の流れ
1. **攻撃条件確認**:
   - 装備武器の耐久度が1以上
   - 射程内に敵が存在
   - 戦闘移動または待機モード中

2. **攻撃間隔**:
   ```
   攻撃間隔（秒） = 90 / 速さ
   
   例：速さ20の忍者 = 4.5秒に1回攻撃
   例：速さ15の忍者 = 6秒に1回攻撃
   ```

3. **攻撃実行**:
   - 刀剣：斬撃エフェクトが敵に向かって飛ぶ
   - 飛び道具：手裏剣が放物線を描いて飛ぶ

4. **命中判定**:
   - 戦闘計算式に基づいて命中判定
   - 命中時：敵に爆発エフェクト表示

5. **耐久度消費**:
   - 攻撃成功/失敗に関わらず武器の耐久度-1
   - 耐久度0になった武器は使用不可

##### アイテム所持システム
- **所持上限**: 各メンバー最大4アイテム
- **アイテム種別**:
  - 武器（刀剣/飛び道具）：戦闘に使用
  - 消耗品（兵糧丸等）：HP回復等に使用
- **装備**: 武器は上にあるものが自動装備される。個別に装備を変更することも可能

##### 攻撃エフェクト仕様
- **斬撃（刀剣）**:
  - 発生位置：攻撃者の位置
  - 移動：敵に向かって直線移動
  - 速度：2マス/秒
  - 見た目：白い弧状の軌跡
- **手裏剣（飛び道具）**:
  - 発生位置：攻撃者の位置
  - 移動：敵に向かって直線移動
  - 速度：2マス/秒
  - 見た目：回転しながら飛ぶ手裏剣
- **ヒットエフェクト**:
  - 命中時：赤い爆発エフェクト（0.3秒）

### 2.2 キャラクターシステム

#### 2.2.1 能力値パラメータ

| パラメータ | 説明 | 最小値 | 最大値 |
|-----------|------|--------|--------|
| HP | 体力 | 20 | 100 |
| 攻撃力 | 物理攻撃力 | 5 | 50 |
| 防御力 | 物理防御力 | 3 | 30 |
| 速さ | 行動速度 | 5 | 50 |
| 移動速度 | 移動能力値（高いほど速い） | 3 | 20 |
| 視界 | 視認可能範囲（マス） | 3 | 10 |

#### 2.2.2 職業（クラス）

**風忍（かぜにん）** - 機動力特化
- **クラス特性**: 移動速度に優れる
- **クラススキル**: 疾風（移動速度+10%）

**鉄忍（てつにん）** - 防御特化  
- **クラス特性**: 高い防御力と体力
- **クラススキル**: 鉄壁（防御力+20%）

**影忍（かげにん）** - ステルス特化
- **クラス特性**: 視界に優れる
- **クラススキル**: 暗視（視界範囲+3）

**薬忍（くすりにん）** - 支援特化
- **クラス特性**: 回復に特化
- **クラススキル**: 医術（兵糧丸を使うと軍団全員に効果が及ぶ）

### 2.3 装備・アイテムシステム

#### 2.3.1 アイテム所持・装備システム
- **所持上限**: 各メンバーが最大4アイテムまで所持可能
- **装備可能数**: 武器は1つのみ装備可能
- **アイテム管理**: 
  - 軍団編成時にアイテムを配布
  - ステージ中はアイテムの受け渡し不可
  - 耐久度0の武器も所持枠を占有

#### 2.3.2 武器システム

| カテゴリ | 武器例 | 攻撃力補正 | 射程 | 耐久度 | 価格 |
|----------|--------|-----------|------|--------|------|
| 刀剣 | 忍者刀 | +10 | 3マス | 100 | 300両 |
| 飛び道具 | 手裏剣 | +5 | 6マス | 100 | 200両 |

##### 武器特性
- **刀剣**: 
  - 近距離攻撃
  - 斬撃エフェクト
  - 地形の影響を受けない
- **飛び道具**: 
  - 遠距離攻撃

#### 2.3.3 消耗品アイテム

| アイテム | 効果 | 使用回数 | 価格 |
|----------|------|----------|------|
| 兵糧丸 | HP全快 | 1回 | 50両 |

## 3. ゲーム進行システム

### 3.1 ステージ構成

#### 3.1.1 キャンペーンモード
- **全3章構成**（各章2ステージ = 合計6ステージ）
- **難易度**: 固定（バランス調整済み）

#### 3.1.2 ステージ設計
- **マップサイズ**: 256*256
- **勝利条件**: 
  - 敵の本拠地を占領する
  - 占領方法：軍団を敵拠点に移動させ、3秒間占領状態を維持
- **敗北条件**: 
  - 全軍団が消滅（指揮官が全員撃破）
  - 咲耶（主人公）が撃破された場合

### 3.2 ステージ進行例

#### チュートリアル章
1. **ステージ1**: 基本操作
   - 移動と戦闘の基礎
   
2. **ステージ2**: 地形効果
   - 森林と山地を使った戦術

#### 第一章：初陣
1. **ステージ3**: 平原の戦い
2. **ステージ4**: 森林防衛戦

#### 第二章：決戦
1. **ステージ5**: 山岳戦
2. **ステージ6**: 最終決戦

## 4. AI システム

### 4.1 敵AI行動パターン（シンプル版）
- **軍団行動**: 最も近い敵軍団を攻撃
- **撤退条件**: 
  - 軍団の生存メンバーが1名になったら撤退
  - 指揮官のHPが30%以下で撤退
- **軍団編成**: ステージ開始時に拠点から自動出撃
- 地形効果を基本的に考慮しない

## 5. UI/UX 詳細設計

### 5.1 画面レイアウト

```
+------------------+--------+
|                  | 軍団   |
|    メイン        | 情報   |
|    ビュー        |        |
|                  |        |
+------------------+--------+
| コマンドパネル    |        |
+------------------+--------+
```

#### 5.1.2 軍団編成画面レイアウト
```
+------------------+------------------+
| 待機兵士リスト    | 編成中軍団       |
|                  |                  |
| [待機忍者]       | 指揮官: [空]     |
| ・風忍A          |                  |
| ・鉄忍B          | 一般兵:          |
| ・影忍C          | 1. [空]          |
| ・薬忍D          | 2. [空]          |
| ・風忍E          | 3. [空]          |
| ・鉄忍F          |                  |
|                  +------------------+
|                  | 出撃位置選択     |
|                  | [拠点周囲マップ] |
+------------------+------------------+
| [キャンセル]      | [出撃]           |
+------------------+------------------+
```

### 5.2 操作系統

#### 5.2.1 マウス操作のみ
- **左クリック**: 選択、移動指示
- **右クリック**: キャンセル

#### 5.2.2 軍団編成画面の操作
- **兵士選択**: 左クリックで待機兵士リストから選択
- **編成追加**: 選択した兵士が編成中軍団に追加される
- **編成解除**: 編成中の兵士を左クリックで待機リストに戻す
- **出撃位置選択**: 拠点周囲マップで出撃可能な場所をクリック
- **出撃実行**: 「出撃」ボタンで軍団を配置
- **キャンセル**: 編成を破棄して通常画面に戻る

### 5.3 情報表示

#### 5.3.1 軍団情報（選択時のみ表示）
- HP/最大HP（バー表示）
- 攻撃力、防御力、移動速度
- 装備武器

## 6. 拠点・内政システム

### 6.1 拠点システム

#### 6.1.1 拠点の種類
- **本拠地**: プレイヤーの初期拠点
  - 軍団編成が可能
  - 兵士の待機場所
  - 失陥すると敗北
- **占領拠点**: マップ上の中立/敵拠点
  - 占領後は軍団編成が可能
  - 追加の収入源

#### 6.1.2 拠点機能
- **軍団編成**: 待機中の兵士から軍団を編成
- **兵士管理**: 待機中の兵士の確認
- **出撃指示**: 軍団を拠点周囲2マスに配置

### 6.2 簡易経済
- **初期資金**: 3000両
- **軍団雇用費**: 200両（ステージ間のみ）
- **兵士雇用**: ステージ間でのみ可能

### 6.3 軍団管理
- **待機兵士システム**:
  - 拠点には待機中の兵士が存在
  - 軍団に編成されていない兵士は拠点で待機
  - 撃破された兵士はそのステージでは復活不可
- **ステージ間管理**:
  - ステージクリア後、生存兵士は次ステージに引き継ぎ
  - 新規兵士の雇用が可能（資金が必要）

## 7. システム要件

### 7.1 性能要件
- **目標FPS**: 30
- **最大同時軍団**: 25軍団（100体÷4人）
- **読み込み時間**: 10秒以内

### 7.2 セーブ機能
- **セーブスロット**: 3つ
- **オートセーブ**: ステージクリア時
- **クイックセーブ**: 戦闘中可能
- **保存項目**: 
  - ゲーム進行状況
  - 所持金
  - 生存兵士の情報
  - クリア済みステージ

## 8. 開発優先順位

### フェーズ1（コア機能）
1. 軍団編成システム
2. 基本的な移動と戦闘（軍団単位）
3. 4種類の忍者クラス（風忍・鉄忍・影忍・薬忍）
4. 個別HP管理と撃破システム
5. 地形効果（3種類）
6. シンプルなAI（軍団行動）

この簡略化された仕様により、コアゲームプレイの検証が可能になります。